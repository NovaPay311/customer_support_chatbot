# Логическая схема продвинутого RAG-конвейера (HyDE + RAG-Fusion)

В ответ на запрос о визуализации логики построения, ниже представлена пошаговая структура продвинутого RAG-конвейера, который может быть реализован с использованием инструмента **Flowise** или аналогичных фреймворков (например, LangChain Expression Language).

Эта схема объединяет техники **HyDE** и **RAG-Fusion** для достижения максимальной релевантности и полноты извлечения контекста.

## 1. Общая архитектура (Flowise-стиль)

Конвейер состоит из трех основных этапов: **Обработка запроса**, **Извлечение контекста** и **Генерация ответа**.

```mermaid
graph TD
    A[Вход: Запрос пользователя] --> B{LLM: Генерация гипотетического ответа (HyDE)};
    A --> C{LLM: Генерация 3-х вариантов запроса (RAG-Fusion)};
    
    B --> D[Векторный поиск 1 (HyDE Embedding)];
    C --> E[Векторный поиск 2 (Вариант 1)];
    C --> F[Векторный поиск 3 (Вариант 2)];
    C --> G[Векторный поиск 4 (Вариант 3)];
    
    D --> H[Объединение результатов поиска];
    E --> H;
    F --> H;
    G --> H;
    
    H --> I{Reciprocal Rank Fusion (RRF)};
    
    I --> J{Reranker (Cohere/BGE): Отбор Топ-5 релевантных документов};
    
    J --> K[LLM: Финальный промпт с контекстом];
    
    K --> L[Выход: Ответ пользователю];
```

## 2. Пошаговое описание логики построения (Узлы Flowise)

Ниже приведена детализация каждого узла и его подключения.

### Этап 1: Обработка запроса

| Узел (Node) | Назначение | Вход | Выход |
| :--- | :--- | :--- | :--- |
| **Input** | Получает исходный запрос пользователя. | - | `query` |
| **LLM Chain (HyDE)** | Использует LLM для генерации подробного, но гипотетического ответа на `query`. | `query` | `hypothetical_answer` |
| **LLM Chain (Query Generator)** | Использует LLM для генерации 3-5 семантически разных поисковых запросов. | `query` | `search_queries` (Список строк) |

### Этап 2: Извлечение контекста (Fusion)

| Узел (Node) | Назначение | Вход | Выход |
| :--- | :--- | :--- | :--- |
| **Embedder (HyDE)** | Векторизует `hypothetical_answer`. | `hypothetical_answer` | `hyde_embedding` |
| **Vector Store Retriever (HyDE)** | Выполняет поиск по `hyde_embedding`. | `hyde_embedding` | `documents_hyde` |
| **Vector Store Retriever (Fusion)** | Выполняет параллельный поиск по каждому из `search_queries`. | `search_queries` | `documents_fusion` (Список списков документов) |
| **Merge Documents** | Объединяет все полученные документы (`documents_hyde` и `documents_fusion`) в один большой список. | `documents_hyde`, `documents_fusion` | `all_documents` |
| **RRF (Reciprocal Rank Fusion)** | Применяет алгоритм RRF для ранжирования и объединения документов из разных поисков. | `all_documents` | `fused_documents` (Ранжированный список) |
| **Reranker (Cohere/BGE)** | Использует специализированную модель Reranker для финального отбора Топ-5 наиболее релевантных документов. | `fused_documents`, `query` | `final_context` (Топ-5 документов) |

### Этап 3: Генерация ответа

| Узел (Node) | Назначение | Вход | Выход |
| :--- | :--- | :--- | :--- |
| **Prompt Template** | Формирует финальный промпт для LLM, включая историю разговора, `query` и `final_context`. | `query`, `final_context`, `history` | `final_prompt` |
| **LLM Chain (Generator)** | Генерирует финальный ответ на основе `final_prompt`. | `final_prompt` | `response` |
| **Output** | Выводит финальный ответ пользователю. | `response` | - |

## 3. Логика подключения (Стрелочки)

| Откуда (Source Node) | Куда (Target Node) | Описание логики |
| :--- | :--- | :--- |
| **Input** | **LLM Chain (HyDE)** | Исходный запрос для генерации гипотетического ответа. |
| **Input** | **LLM Chain (Query Generator)** | Исходный запрос для генерации вариантов поиска. |
| **LLM Chain (HyDE)** | **Embedder (HyDE)** | Гипотетический ответ для векторизации. |
| **Embedder (HyDE)** | **Vector Store Retriever (HyDE)** | Вектор для поиска в базе данных. |
| **LLM Chain (Query Generator)** | **Vector Store Retriever (Fusion)** | Варианты запросов для параллельного поиска. |
| **Все Retriever'ы** | **Merge Documents** | Все извлеченные документы объединяются. |
| **Merge Documents** | **RRF** | Объединенный список документов для переранжирования по RRF. |
| **RRF** | **Reranker** | Ранжированные документы для финального отбора. |
| **Reranker** | **Prompt Template** | Финальный, высокорелевантный контекст для промпта. |
| **Prompt Template** | **LLM Chain (Generator)** | Финальный промпт для генерации ответа. |
| **LLM Chain (Generator)** | **Output** | Финальный ответ пользователю. |
